name: Deploy Backends

on:
  push:
    branches: [main, develop]
    paths:
      - "backend/**"
      - ".github/workflows/deploy.yml"
      - "infrastructure/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "backend/**"
      - ".github/workflows/deploy.yml"
      - "infrastructure/**"
  workflow_dispatch: # 手動觸發
    inputs:
      environment:
        description: "部署環境"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
env:
  PROJECT_ID: toastlabplus
  GAR_LOCATION: asia-east1
  GAR_REPOSITORY: toastlabplus-repo
  CLOUD_RUN_REGION: asia-east1
  # Workload Identity
  WORKLOAD_IDENTITY_PROVIDER: projects/96030530148/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-actions@toastlabplus.iam.gserviceaccount.com
  # Secret Manager 中的 Secret 名稱
  GEMINI_API_KEY_SECRET: GEMINI_API_KEY
  DB_PASSWORD_SECRET: DB_PASSWORD
  DB_USER_SECRET: DB_USER
  # VPC Connector
  VPC_CONNECTOR: projects/toastlabplus/locations/asia-east1/connectors/serverless-connector
  # Cloud SQL
  CLOUD_SQL_CONNECTION: toastlabplus:asia-east1:toastlabplus-db

jobs:
  # ============================================
  # Build and Push MCP Server (Spring Boot)
  # ============================================
  build-mcp-server:
    name: Build MCP Server
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # 必要：Workload Identity 需要此權限

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build with Maven
        working-directory: ./backend/mcp-server
        run: mvn clean package -DskipTests -B

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        working-directory: ./backend/mcp-server
        run: |
          docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/mcp-server:${{ github.sha }} .
          docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/mcp-server:latest .
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/mcp-server:${{ github.sha }}
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/mcp-server:latest

  # ============================================
  # Build and Push Chat Backend (Python)
  # ============================================
  build-chat-backend:
    name: Build Chat Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        working-directory: ./backend/chat-backend
        run: |
          docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/chat-backend:${{ github.sha }} .
          docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/chat-backend:latest .
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/chat-backend:${{ github.sha }}
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/chat-backend:latest

  # ============================================
  # Deploy to Staging (develop branch only)
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    needs: [build-mcp-server, build-chat-backend]
    if: (github.ref == 'refs/heads/develop' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy MCP Server to Cloud Run (Staging)
        run: |
          gcloud run deploy mcp-server-staging \
            --image=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/mcp-server:${{ github.sha }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --cpu=0.5 \
            --memory=512Mi \
            --min-instances=0 \
            --max-instances=3 \
            --vpc-connector=${{ env.VPC_CONNECTOR }} \
            --add-cloudsql-instances=${{ env.CLOUD_SQL_CONNECTION }} \
            --set-secrets="DB_PASSWORD=${{ env.DB_PASSWORD_SECRET }}:latest,DB_USER=${{ env.DB_USER_SECRET }}:latest" \
            --set-env-vars="SPRING_PROFILES_ACTIVE=staging,INSTANCE_CONNECTION_NAME=${{ env.CLOUD_SQL_CONNECTION }},DB_NAME=toastlabplus_staging,DB_USER_SECRET=${{ env.DB_USER_SECRET }}" \
            --allow-unauthenticated

      - name: Deploy Chat Backend to Cloud Run (Staging)
        run: |
          gcloud run deploy chat-backend-staging \
            --image=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/chat-backend:${{ github.sha }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --cpu=0.5 \
            --memory=512Mi \
            --min-instances=0 \
            --max-instances=3 \
            --set-secrets="GEMINI_API_KEY=${{ env.GEMINI_API_KEY_SECRET }}:latest" \
            --set-env-vars="ENVIRONMENT=staging,GCP_PROJECT_ID=${{ env.PROJECT_ID }}" \
            --allow-unauthenticated

      - name: Get Staging URLs
        run: |
          echo "## Staging Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Server: $(gcloud run services describe mcp-server-staging --region=${{ env.CLOUD_RUN_REGION }} --format='value(status.url)')" >> $GITHUB_STEP_SUMMARY
          echo "- Chat Backend: $(gcloud run services describe chat-backend-staging --region=${{ env.CLOUD_RUN_REGION }} --format='value(status.url)')" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Production (main branch only)
  # ============================================
  deploy-production:
    name: Deploy to Production
    needs: [build-mcp-server, build-chat-backend]
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy MCP Server to Cloud Run (Production)
        run: |
          gcloud run deploy mcp-server \
            --image=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/mcp-server:${{ github.sha }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --cpu=0.5 \
            --memory=512Mi \
            --min-instances=1 \
            --max-instances=10 \
            --vpc-connector=${{ env.VPC_CONNECTOR }} \
            --add-cloudsql-instances=${{ env.CLOUD_SQL_CONNECTION }} \
            --set-secrets="DB_PASSWORD=${{ env.DB_PASSWORD_SECRET }}:latest,DB_USER=${{ env.DB_USER_SECRET }}:latest" \
            --set-env-vars="SPRING_PROFILES_ACTIVE=production,INSTANCE_CONNECTION_NAME=${{ env.CLOUD_SQL_CONNECTION }},DB_NAME=toastlabplus" \
            --allow-unauthenticated

      - name: Deploy Chat Backend to Cloud Run (Production)
        run: |
          gcloud run deploy chat-backend \
            --image=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/chat-backend:${{ github.sha }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --cpu=0.5 \
            --memory=512Mi \
            --min-instances=1 \
            --max-instances=10 \
            --set-secrets="GEMINI_API_KEY=${{ env.GEMINI_API_KEY_SECRET }}:latest" \
            --set-env-vars="ENVIRONMENT=production,GCP_PROJECT_ID=${{ env.PROJECT_ID }}" \
            --allow-unauthenticated

      - name: Get Production URLs
        run: |
          echo "## Production Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Server: $(gcloud run services describe mcp-server --region=${{ env.CLOUD_RUN_REGION }} --format='value(status.url)')" >> $GITHUB_STEP_SUMMARY
          echo "- Chat Backend: $(gcloud run services describe chat-backend --region=${{ env.CLOUD_RUN_REGION }} --format='value(status.url)')" >> $GITHUB_STEP_SUMMARY
