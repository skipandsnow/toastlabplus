name: Deploy iOS to App Store

on:
    workflow_dispatch:
        inputs:
            deployment_target:
                description: "éƒ¨ç½²ç›®æ¨™"
                required: true
                default: "testflight"
                type: choice
                options:
                    - testflight
                    - app_store
            version:
                description: "ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 2.1.0)ï¼Œç•™ç©ºå‰‡ä½¿ç”¨ pubspec.yaml ä¸­çš„ç‰ˆæœ¬"
                required: false
                type: string
            build_number:
                description: "Build Numberï¼Œç•™ç©ºå‰‡è‡ªå‹•ä½¿ç”¨ run number"
                required: false
                type: string

env:
    FLUTTER_VERSION: "3.38.5"
    XCODE_VERSION: "16.1"

jobs:
    build-and-deploy-ios:
        name: Build and Deploy iOS
        runs-on: macos-15
        timeout-minutes: 60

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Select Xcode version
              run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: "stable"
                  cache: true

            - name: Get Flutter dependencies
              working-directory: ./mobile/toastlabplus_app
              run: flutter pub get

            - name: Install CocoaPods dependencies
              working-directory: ./mobile/toastlabplus_app/ios
              run: pod install --repo-update

            - name: Setup App Store Connect API Key
              env:
                  APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
                  APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
                  APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
              run: |
                  mkdir -p ~/private_keys
                  echo "$APP_STORE_CONNECT_PRIVATE_KEY" > ~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

            - name: Determine version and build number
              id: version
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    VERSION=$(grep '^version:' ./mobile/toastlabplus_app/pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
                  fi

                  if [ -n "${{ github.event.inputs.build_number }}" ]; then
                    BUILD_NUMBER="${{ github.event.inputs.build_number }}"
                  else
                    BUILD_NUMBER="${{ github.run_number }}"
                  fi

                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                  echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
                  echo "ðŸ“¦ Version: $VERSION ($BUILD_NUMBER)"

            - name: Build iOS IPA
              working-directory: ./mobile/toastlabplus_app
              env:
                  APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
                  APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
              run: |
                  flutter build ipa \
                    --release \
                    --build-name=${{ steps.version.outputs.VERSION }} \
                    --build-number=${{ steps.version.outputs.BUILD_NUMBER }} \
                    --export-options-plist=ios/ExportOptions.plist \
                    --dart-define=MCP_SERVER_URL=https://mcp-server-96030530148.asia-east1.run.app \
                    --dart-define=CHAT_BACKEND_URL=https://chat-backend-96030530148.asia-east1.run.app

            - name: Upload to App Store Connect
              env:
                  APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
                  APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
              run: |
                  xcrun altool --upload-app \
                    --type ios \
                    --file ./mobile/toastlabplus_app/build/ios/ipa/*.ipa \
                    --apiKey ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
                    --apiIssuer ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

            - name: Upload IPA artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ios-ipa-${{ steps.version.outputs.VERSION }}-${{ steps.version.outputs.BUILD_NUMBER }}
                  path: ./mobile/toastlabplus_app/build/ios/ipa/*.ipa
                  retention-days: 30

            - name: Summary
              run: |
                  echo "## ðŸŽ iOS Build Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Version** | ${{ steps.version.outputs.VERSION }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Build Number** | ${{ steps.version.outputs.BUILD_NUMBER }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Target** | ${{ github.event.inputs.deployment_target }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Bundle ID** | com.skipandsnow.toastlabplus |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ github.event.inputs.deployment_target }}" == "testflight" ]; then
                    echo "âœ… Build uploaded to **TestFlight**. Check App Store Connect for processing status." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âœ… Build uploaded to **App Store Connect**. Submit for review in the console." >> $GITHUB_STEP_SUMMARY
                  fi
